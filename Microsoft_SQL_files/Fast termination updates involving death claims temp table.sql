drop table #Temp;

select  
poh_policynumber
,Max(Txh_effectivedate) AS Max_TxhEffectiveDate
,psti.Pst_DESCRIPTION_I                              AS FAST_PolicyStatus
,PcsI.Pst_DESCRIPTION_I                              AS FAST_PolCovStatus
,txt.txt_description_i                      as trxtype
,CONVERT(VARCHAR(10),pch.Pch_TERMINATIONDATE,120) AS FAST_CovTerminationDate
INTO #Temp
FROM cm_opt_poh_policyhdr_s poh
inner join Cm_Opt_Txh_TrxHdr_S txh on (txh.Txh_POLICYHDRID=poh.poh_ID)
inner join [dbo].[Cm_Sys_Txt_TrxType_I] txt on txt.txt_id_i= txh.txh_trxtypeid
INNER JOIN Cm_Opt_pch_policycovhdr_s        pch       ON poh.Poh_ID = pch.Pch_POLICYHDRID 
INNER JOIN Cm_Sys_Pst_PolicyStatus_I        PstI      ON PstI.Pst_ID_I = Poh.Poh_STATUS       -- Policy Status
INNER JOIN Cm_Sys_Pst_PolicyStatus_I        PcsI      ON PcsI.Pst_ID_I = Pch.Pch_STATUS       -- Policy Coverage Status

where  poh.Poh_POLICYNUMBER in (

'TM10026900',
'UL0006158',
'UL0015052',
'UL0034959',
'UL0035256',
'UL0042489',
'UL0044376',
'UL0044448',
'0004001635',
'0004002175',
'0004007975',
'0004008255',
'0004008285',
'0004011555',
'0004019525',
'0004021835',
'0004025395',
'0004030015',
'0004030445',
'0004031655',
'0004034075',
'0004034125',
'0004034835',
'0004038925',
'0004038975',
'0004040705',
'0004049295',
'0004051015',
'0004051155',
'0004051684',
'0004053255',
'0004054135',
'0004056805',
'0004056845',
'0004057335',
'0004060385',
'0004061745',
'0004072800',
'0004074360',
'0004075520',
'0004077070',
'0004077470',
'0004077980',
'0004079410',
'0004081240',
'0004081260',
'0004081270',
'0004081280',
'0004081290',
'0004081540',
'0004081580',
'0004083150',
'0004086470',
'0004089530',
'0004090050',
'0004090450',
'0004091990',
'0004093360',
'0004098080',
'0007500890',
'0007502250',
'0007502550',
'0007502950',
'0007504160',
'0007505100',
'0007506330',
'0007507410',
'0007509710',
'0007511590',
'0008002470',
'0008005930',
'0008006760',
'0008007680',
'0008010300',
'0008012570',
'0008014160',
'0008014170',
'0008017350',
'0008017620',
'0008018570',
'0008019140',
'0008021100',
'0008023230',
'0008023400',
'0008024930',
'0008025780',
'0008026360',
'0008028340',
'0008028780',
'0008029710',
'0008033170',
'0008034570',
'0008035270',
'0008036050',
'0008037960',
'0008039680',
'0008039910',
'0008041040',
'0008041340',
'0008042140',
'0008042220',
'0008042310',
'0008042990',
'0008043080',
'0008043330',
'0008043740',
'0008049270',
'0008050690',
'0008050850',
'0008051070',
'0008051890',
'0008052470',
'0008052540',
'0008052660',
'0008053370',
'0008054310',
'0008054730',
'0008056190',
'0008058860',
'0008059450',
'0008060340',
'0008061070',
'0008061230',
'0008061910',
'0008062310',
'0008062990',
'0008064480',
'0008066820',
'0008067400',
'0008067930',
'0008070220',
'0008075000',
'0008076210',
'0008076330',
'0008078080',
'0008078120',
'0008078860',
'0008079280',
'0008079460',
'0008079690',
'0008080200',
'0008080450',
'0008081720',
'0008081730',
'0008082250',
'0008083130',
'0008084640',
'0008085150',
'0008088550',
'0008089780',
'0008090190',
'0008090420',
'0008091760',
'0008092820',
'0008094110',
'0008095370',
'0008095900',
'0008095920',
'0008096070',
'0008096570',
'0008096880',
'0008097070',
'0008097400',
'0008097420',
'0008097470',
'0008098680',
'0008100160',
'0008100760',
'0008100860',
'0008102360',
'0008104630',
'0008107410',
'0008107950',
'0008109760',
'0008112690',
'0008112880',
'0008114940',
'0008119800',
'0008120830',
'0008121850',
'0008122940',
'0008124430',
'0008129200',
'0008130440',
'0008131470',
'0008132550',
'0008132790',
'0008135230',
'0008138950',
'2220003299',
'2220003526',
'2220004287',
'BU00025242',
'KP00002896',
'KP00003475',
'KP00003491',
'KP00003737',
'KP00003965',
'KP00005232',
'KP00005398',
'KP00007179',
'KP00008410',
'KP00010201',
'KP00010972',
'KP00011365',
'KP00012437',
'KP00013038',
'KP00013420',
'KP00013741',
'KP00013780',
'KP00014402',
'KP00014831',
'KP00014883',
'KP00016079',
'KP00016083',
'KP00016396',
'KP00017165',
'KP00018541',
'KP00024133',
'KP00025827',
'KP00032862',
'KP00037318',
'KP00041080',
'KP00046238',
'KP00048488',
'KP00055107',
'KP00057909',
'KP00064289',
'KP00071924',
'KP00072999',
'KP00122404',
'KP00189378',
'TM10012110',
'TM10015130',
'TM10015370',
'TM10017400',
'TM10017750',
'TM10023520',
'TM10023780',
'TM10024670',
'TM10026590',
'TM10026850',
'TM10030890',
'TM10032070',
'TM10035750',
'TM10038510',
'TM10040540',
'TM10040580',
'TM10042070',
'TM10043760',
'TM10043950',
'TM10048050',
'TM10049660',
'TM10050730',
'TM10052280',
'TM10053250',
'TM10410370',
'TM10410450',
'TM10410451',
'TM10410508',
'TM10410573',
'TM10410677',
'TM10410681',
'TM10410890',
'TM20000493',
'TM20000501',
'TM20000761',
'TM20000805',
'TM20000849',
'TM20001574',
'TM20001988',
'TM20002005',
'TM20003303',
'TM20003772',
'TM20410241',
'TM30000673',
'TM30001043',
'TM30001541',
'TM30001817',
'TM30001911',
'TM30002116',
'TM30002206',
'TM30002666',
'TM30002857',
'TM30003587',
'TM30003715',
'TM30004004',
'TM30004012',
'TM30004097',
'TM30004192',
'TM30004299',
'TM30004665',
'TM30004812',
'TM30005093',
'TM30005306',
'TM30005447',
'TM30005459',
'TM30005530',
'TM30005603',
'TM30006164',
'TM30006174',
'TM30006387',
'TM40006100',
'TM40009640',
'TM40015300',
'TM40017650',
'TM40018620',
'TM40018630',
'TM40018640',
'TM40018680',
'TM40019510',
'TM40022230',
'TM40024520',
'TM40025320',
'TM40026340',
'TM40026560',
'TM40027650',
'TM40028000',
'TM40028050',
'TM40030550',
'TM40031540',
'TM40034280',
'TM40035280',
'TM40035880',
'TM40038810',
'TM40044270',
'TM40045220',
'TM40045500',
'TM40046210',
'TM40051800',
'TM40052320',
'TM40053870',
'TM40054270',
'TM40060200',
'TM40063430',
'TM40066870',
'TM44128430',
'TM44133050',
'TM44136350',
'TM44136840',
'TM44136900',
'TM50001026',
'UL0000260',
'UL0029281',
'UL0029735',
'UL0033613',
'UL0036536',
'UV0000777Q',
'UZ1000013X',
'UZ1000099H',
'UZ1000139W',
'UZ1000308V',
'TM30413366',
'0008020020',
'0008055960',
'2220002123',
'KP00004769',
'TM10027970',
'TM20000405',
'TM40059430',
'UL0014779',
'UL0034176',
'UZ1000319V',
'0004020785',
'2220001034',
'2220001643',
'2220003604',
'2220006926',
'777000878',
'777001584',
'UL0000309',
'UL0000387',
'UL0000665',
'UL0000763',
'UL0001024',
'UL0001675',
'UL0002041',
'UL0002252',
'UL0002413',
'UL0002546',
'UL0002814',
'UL0003163',
'UL0003172',
'UL0003386',
'UL0003889',
'UL0004418',
'UL0004622',
'UL0004682',
'UL0004827',
'UL0005274',
'UL0005342',
'UL0005344',
'UL0005633',
'UL0005771',
'UL0006431',
'UL0006734',
'UL0008324',
'UL0008901',
'UL0009028',
'UL0009713',
'UL0009852',
'UL0009915',
'UL0010265',
'UL0010476',
'UL0010516',
'UL0010788',
'UL0010981',
'UL0011377',
'UL0011507',
'UL0011705',
'UL0013548',
'UL0014004',
'UL0014940',
'UL0015099',
'UL0015104',
'UL0015473',
'UL0015542',
'UL0015741',
'UL0015942',
'UL0016602',
'UL0016652',
'UL0016658',
'UL0016670',
'UL0016735',
'UL0017193',
'UL0017303',
'UL0017553',
'UL0017554',
'UL0018141',
'UL0018622',
'UL0019426',
'UL0019782',
'UL0020045',
'UL0021261',
'UL0021264',
'UL0021892',
'UL0022095',
'UL0022212',
'UL0022748',
'UL0023244',
'UL0023272',
'UL0023276',
'UL0023809',
'UL0024518',
'UL0025427',
'UL0025663',
'UL0026753',
'UL0027058',
'UL0027230',
'UL0027433',
'UL0028068',
'UL0028247',
'UL0028373',
'UL0028451',
'UL0028643',
'UL0029001',
'UL0029038',
'UL0029039',
'UL0029742',
'UL0029828',
'UL0029868',
'UL0029990',
'UL0030289',
'UL0030298',
'UL0030681',
'UL0030751',
'UL0030826',
'UL0031400',
'UL0031800',
'UL0032385',
'UL0032949',
'UL0032973',
'UL0033021',
'UL0033033',
'UL0033076',
'UL0033432',
'UL0033862',
'UL0034064',
'UL0034668',
'UL0035084',
'UL0035165',
'UL0035917',
'UL0036066',
'UL0036108',
'UL0036220',
'UL0036520',
'UL0036542',
'UL0036647',
'UL0036718',
'UL0036937',
'UL0037138',
'UL0038884',
'UL0039052',
'UL0039408',
'UL0040251',
'UL0041162',
'UL0041613',
'UL0041748',
'UL0041760',
'UL0043116',
'UL0043569',
'UL0043717',
'UL0044030',
'UL0044247',
'UL0044250',
'UZ1001109T',
'0008014690',
'0008042500',
'0008059370',
'TM10012820',
'TM10015770',
'TM30001489',
'UV0000525T',
'UZ1000174Q',
'UZ1000794T',
'UV0000732T',
'UV0001106X',
'UV0002469V',
'UL0018605',
'UL0024500',
'UL0035167',
'0004007945',
'0004010055',
'0004011075',
'0004013254',
'0004018074',
'0004018084',
'0004028105',
'0004040555',
'0004042405',
'0004045835',
'0004048315',
'0004050175',
'0004050195',
'0004052065',
'0004060235',
'0004061015',
'0004071150',
'0004082170',
'0004087970',
'0004089750',
'0004095470',
'0007503770',
'0008003710',
'0008015530',
'0008020110',
'0008035450',
'0008036780',
'0008037680',
'0008039130',
'0008045480',
'0008055050',
'0008066210',
'0008076770',
'0008088810',
'0008091640',
'0008095410',
'0008103880',
'0008104470',
'0008108370',
'0008109490',
'0008109500',
'0008115480',
'0008117020',
'0008117860',
'0008122040',
'0008122220',
'0008124360',
'0008128840',
'0008129360',
'0008132390',
'0008135690',
'0008137580',
'0008137770',
'2220000284',
'2220001446',
'2220001774',
'2220003770',
'2220004092',
'2220004330',
'2220004823',
'2220004911',
'2220004976',
'2220006581',
'2220008065',
'3330000054',
'BU00033153',
'KP00001778',
'KP00002753',
'KP00006673',
'KP00007535',
'KP00008399',
'KP00013742',
'KP00016857',
'KP00017214',
'KP00017730',
'KP00019650',
'KP00019651',
'KP00029368',
'KP00029862',
'KP00037179',
'KP00042721',
'KP00047307',
'KP00049352',
'KP00060206',
'KP00086026',
'KP00088593',
'KP00117359',
'KP00162393',
'TM10015200',
'TM10018410',
'TM10022010',
'TM10026980',
'TM10027260',
'TM10031040',
'TM10035690',
'TM10039540',
'TM10040140',
'TM10046680',
'TM10049600',
'TM10052310',
'TM10054120',
'TM10410188',
'TM10410294',
'TM10410495',
'TM10410910',
'TM20000522',
'TM20001442',
'TM20001635',
'TM20002111',
'TM20002725',
'TM20003924',
'TM20004272',
'TM30000348',
'TM30000702',
'TM30002075',
'TM30002223',
'TM30002270',
'TM30002538',
'TM30002539',
'TM30002540',
'TM30002705',
'TM30002972',
'TM30002973',
'TM30003032',
'TM30003373',
'TM30003671',
'TM30004159',
'TM30004955',
'TM30005959',
'TM30005968',
'TM30006482',
'TM40022340',
'TM40026230',
'TM40026770',
'TM40033200',
'TM40040400',
'TM40041580',
'TM40049440',
'UL0016942',
'UL0017728',
'UL0022038',
'UL0022583',
'UL0025431',
'UL0028178',
'UL0029232',
'UL0030516',
'UL0030741',
'UL0035616',
'UL0037784',
'UL0039835',
'UL0040354',
'UL0040355',
'UL0042096',
'UV0000188T',
'UV0000658H',
'UV0002056R',
'UZ1000783T',
'UZ1000965D') 

and txt_description_i =  'death claim'


group by poh_policynumber, Pch_TERMINATIONDATE, psti.Pst_DESCRIPTION_I, PcsI.Pst_DESCRIPTION_I, txt_description_i 


select distinct tmp.Poh_POLICYNUMBER, tmp.Max_TxhEffectiveDate, pch.Pch_TERMINATIONDATE
from #Temp AS tmp
inner join cm_opt_poh_policyhdr_s poh on poh.Poh_POLICYNUMBER = tmp.Poh_POLICYNUMBER
inner join Cm_Opt_Pch_PolicyCovHdr_S as pch on poh.Poh_ID = pch.Pch_POLICYHDRID
inner join Cm_Opt_Txh_TrxHdr_S txh on (txh.Txh_POLICYHDRID=poh.poh_ID) AND txh.Txh_EFFECTIVEDATE = tmp.Max_TxhEffectiveDate
order by tmp.Poh_POLICYNUMBER

begin tran
update pch
set pch.Pch_TERMINATIONDATE = tmp.Max_TxhEffectiveDate
	,pch.Pch_TIMESTAMP = CURRENT_TIMESTAMP
from #Temp AS tmp
inner join cm_opt_poh_policyhdr_s poh on poh.Poh_POLICYNUMBER = tmp.Poh_POLICYNUMBER
inner join Cm_Opt_Pch_PolicyCovHdr_S as pch on poh.Poh_ID = pch.Pch_POLICYHDRID
inner join Cm_Opt_Txh_TrxHdr_S txh on (txh.Txh_POLICYHDRID=poh.poh_ID) AND txh.Txh_EFFECTIVEDATE = tmp.Max_TxhEffectiveDate

rollback tran