select QuoteID, case when (convert(date,SYSDATETIME()) >= CONVERT (date, AnnContractIssueDate) and DueToDeath='N' and ((GMIBUsed is null and GMIBEligible is null) or not (GMIBUsed = 'Y' and GMIBEligible = 'N') ) ) or (DueToDeath='Y' and SSNAnnuitized < 1) then 1 else 0 end as 'CanAnnuitize', case when DueToDeath='N' and AnnDate is not null then 1 else 0 end as 'HasAnnuitized'  
from ( select q.quoteid, q.AuditDate, qfv2.FieldValue as 'AnnDate', qfv3.FieldValue as 'DueToDeath', qfv4.FieldValue as 'AnnContractIssueDate', qfv5.FieldValue as 'GMIBUsed', qfv6.FieldValue as 'GMIBEligible', COUNT(qfv9.FieldValue) as 'SSNAnnuitized' 
from Quote q   
inner join QuoteFieldValues qfv1 on qfv1.QuoteID=q.QuoteID and qfv1.FieldName='Contract Number' and qfv1.FieldValue='KA00281052'  
inner join QuoteFieldValues qfv2 on qfv2.QuoteID=qfv1.QuoteID and qfv2.QuoteID=q.QuoteID and qfv2.FieldName='Annuitization Date' 
inner join QuoteFieldValues qfv3 on qfv3.FieldName='Due To Death?'  and q.QuoteID=qfv3.QuoteID  and q.clientid=22 inner join QuoteFieldValues qfv4 on qfv4.FieldName='Annuitization Contract Issue Date' and q.QuoteID = qfv4.QuoteID left outer join QuoteFieldValues qfv5 on qfv4.FieldName='Use GMIB Illustration Indicator' and q.QuoteID = qfv5.QuoteID left outer join QuoteFieldValues qfv6 on qfv4.FieldName='GMIB Eligible' and q.QuoteID = qfv6.QuoteID inner join QuoteFieldValues qfv7 on qfv7.FieldName = 'Annuitant SSN' and qfv7.QuoteID = q.QuoteID inner join QuoteFieldValues qfv8 on qfv8.quoteid=q.quoteid and qfv8.FieldName='Payment Type' and qfv8.FieldValue='Fixed'
left outer join QuoteFieldValues qfv9 on qfv9.QuoteID in (select QuoteID from QuoteFieldValues where FieldName = 'Annuitant SSN' and FieldValue = qfv7.FieldValue) and qfv9.FieldName = 'Annuitization Date' and qfv9.FieldValue is not null 
left outer join  QuoteReport qr on qr.QuoteID=q.QuoteID   group by q.quoteid, q.AuditDate, qfv2.FieldValue,  qfv3.FieldValue, qfv4.FieldValue, qfv5.FieldValue, qfv6.FieldValue, qfv9.FieldValue having COUNT(qr.QuoteID) > 0) x    where convert(date,AuditDate) = CONVERT (date, SYSDATETIME())
